name: Auto PR on push

on:
  push:
    branches-ignore:
      - main
      - master

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
          HEAD_BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ "$HEAD_BRANCH" = "$BASE_BRANCH" ]; then
            echo "Head branch is base; skipping"
            exit 0
          fi

          count=$(gh pr list --repo "$REPO" --head "$HEAD_BRANCH" --base "$BASE_BRANCH" --state open --json number --jq 'length')
          if [ "$count" -gt 0 ]; then
            echo "PR already exists"
            exit 0
          fi

          gh pr create \
            --repo "$REPO" \
            --head "$HEAD_BRANCH" \
            --base "$BASE_BRANCH" \
            --title "$HEAD_BRANCH" \
            --body "Automated PR for branch \`$HEAD_BRANCH\`."
